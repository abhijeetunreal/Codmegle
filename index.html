<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Codmegle - Talk to Strangers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            font-weight: 400;
            letter-spacing: -0.01em;
        }
        
        /* Mobile optimizations */
        @media (max-width: 640px) {
            body {
                -webkit-tap-highlight-color: transparent;
            }
            /* Prevent zoom on input focus on iOS */
            input, textarea, select {
                font-size: 16px !important;
            }
        }
        
        /* Desktop optimizations */
        @media (min-width: 1024px) {
            .container-max {
                max-width: 1400px;
                margin: 0 auto;
            }
        }
        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 5px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .scale-x-flip { transform: scaleX(-1); }
        
        /* Custom gradient backgrounds */
        .bg-gradient-primary {
            background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
        }
        .bg-gradient-welcome {
            background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 50%, #E2E8F0 100%);
        }
        .bg-gradient-message-you {
            background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
        }
        .bg-gradient-message-stranger {
            background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%);
        }
        
        /* Smooth transitions */
        * {
            transition-property: color, background-color, border-color, transform, opacity;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 200ms;
        }
        
        /* Button hover effects */
        .btn-primary {
            transition: all 0.2s ease;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 20px -5px rgba(59, 130, 246, 0.4);
        }
        .btn-primary:active {
            transform: translateY(0);
        }
        
        /* Message bubble animation */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .message-bubble {
            animation: slideIn 0.3s ease-out;
        }
        
        /* Pulse animation for status */
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .pulse-slow {
            animation: pulse-slow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="bg-gradient-welcome h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 p-3 sm:p-4 flex justify-between items-center shadow-md h-14 sm:h-16 shrink-0 z-10 backdrop-blur-sm bg-white/95">
        <div class="flex items-center select-none cursor-pointer group" onclick="window.location.reload()">
            <span class="text-2xl sm:text-3xl font-extrabold tracking-tight text-gray-800 group-hover:text-blue-600 transition-colors">Cod</span>
            <span class="text-2xl sm:text-3xl font-extrabold tracking-tight text-white bg-gradient-to-r from-orange-500 to-orange-600 px-1.5 sm:px-2 py-0.5 transform -rotate-2 shadow-lg inline-block ml-0.5 sm:ml-1 rounded-md group-hover:shadow-xl transition-shadow">megle</span>
        </div>
        <div class="flex items-center gap-1.5 sm:gap-2">
            <div class="h-1.5 w-1.5 sm:h-2 sm:w-2 bg-green-500 rounded-full pulse-slow"></div>
            <div class="text-xs sm:text-sm md:text-base text-gray-600 font-semibold px-2 sm:px-3 py-1 sm:py-1.5 bg-gray-100 rounded-full whitespace-nowrap" id="online-count">
                Connecting...
            </div>
        </div>
    </header>

    <!-- Welcome Screen -->
    <div id="welcome-screen" class="flex-1 flex flex-col items-center justify-center p-4 sm:p-6 text-center overflow-y-auto">
        <div class="bg-white p-6 sm:p-8 md:p-10 lg:p-12 rounded-xl sm:rounded-2xl shadow-2xl max-w-3xl w-full border border-gray-100 transform transition-all duration-300 hover:shadow-3xl mx-2 sm:mx-4">
            <div class="mb-6 sm:mb-8">
                <h1 class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl font-extrabold mb-3 sm:mb-4 bg-gradient-to-r from-blue-600 via-blue-500 to-blue-600 bg-clip-text text-transparent px-2">
                    Talk to strangers!
                </h1>
                <p class="text-gray-600 mb-2 text-base sm:text-lg md:text-xl leading-relaxed max-w-2xl mx-auto px-2">
                    Codmegle is a great place to meet new friends. When you use Codmegle, 
                    we pick someone else at random and let you talk one-on-one.
                </p>
            </div>
            
            <div class="bg-gradient-to-r from-amber-50 to-yellow-50 border-l-4 border-amber-500 p-4 sm:p-5 mb-6 sm:mb-8 md:mb-10 text-left rounded-r-lg shadow-sm">
                <div class="flex items-start gap-3">
                    <i data-lucide="alert-triangle" class="w-5 h-5 text-amber-600 mt-0.5 flex-shrink-0"></i>
                    <div>
                        <p class="font-bold text-amber-900 mb-2 text-base">Terms of Service:</p>
                        <ul class="list-disc list-inside space-y-1.5 text-sm text-amber-800">
                            <li>You must be 18+ to use this site.</li>
                            <li>Do not transmit nudity, sexually explicit content, or illegal material.</li>
                            <li>Be respectful to others.</li>
                            <li><strong>Opening two tabs allows you to chat with yourself for testing!</strong></li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="space-y-4 sm:space-y-6">
                <div class="text-gray-700 font-semibold mb-3 sm:mb-4 text-base sm:text-lg">Start chatting:</div>
                <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 justify-center px-2">
                    <button onclick="app.startChat('text')" class="btn-primary w-full sm:w-auto px-8 sm:px-10 py-4 sm:py-5 bg-white border-2 border-gray-300 text-gray-700 font-bold text-base sm:text-lg rounded-xl hover:border-blue-400 hover:bg-blue-50 hover:text-blue-700 shadow-md active:translate-y-0.5 flex items-center justify-center gap-2 transition-all">
                        <i data-lucide="message-square" class="w-5 h-5"></i>
                        <span>Text only</span>
                    </button>
                    <button onclick="app.startChat('video')" class="btn-primary w-full sm:w-auto px-8 sm:px-10 py-4 sm:py-5 bg-gradient-primary text-white font-bold text-base sm:text-lg rounded-xl hover:shadow-xl shadow-lg active:translate-y-0.5 flex items-center justify-center gap-2 transition-all">
                        <i data-lucide="video" class="w-5 h-5"></i>
                        <span>Video</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Screen -->
    <div id="chat-screen" class="hidden flex-1 flex flex-col h-full overflow-hidden bg-gradient-to-b from-gray-50 to-white">
        
        <!-- Video Container -->
        <div id="video-container" class="hidden h-48 sm:h-64 md:h-80 lg:h-96 bg-gradient-to-br from-gray-900 to-black relative flex justify-center items-center shrink-0 border-b-2 border-gray-800 shadow-2xl">
            <div class="w-full h-full relative">
                <!-- Remote Video Placeholder -->
                <div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-gray-900 via-gray-800 to-black" id="remote-video-container">
                    <div class="text-center">
                        <div class="pulse-slow mb-4">
                            <div class="mx-auto w-16 h-16 bg-blue-600/20 rounded-full flex items-center justify-center">
                                <i data-lucide="video" class="text-blue-400 w-8 h-8"></i>
                            </div>
                        </div>
                        <p class="text-gray-400 text-sm font-medium">Waiting for remote video...</p>
                    </div>
                </div>
                <div id="video-waiting-msg" class="absolute inset-0 flex items-center justify-center bg-black/70 backdrop-blur-sm text-gray-300 hidden">
                    <div class="text-center">
                        <div class="pulse-slow mb-3">
                            <div class="mx-auto w-12 h-12 bg-blue-500/20 rounded-full flex items-center justify-center">
                                <i data-lucide="users" class="text-blue-400 w-6 h-6"></i>
                            </div>
                        </div>
                        <p class="font-semibold">Waiting for partner...</p>
                    </div>
                </div>

                <!-- Local Video -->
                <div class="absolute bottom-2 right-2 sm:bottom-4 sm:right-4 w-24 h-18 sm:w-32 sm:h-24 md:w-40 md:h-30 lg:w-48 lg:h-36 bg-gray-800 border-2 sm:border-4 border-white shadow-2xl overflow-hidden rounded-lg sm:rounded-xl ring-1 sm:ring-2 ring-blue-500/50">
                    <video id="local-video" autoplay playsinline muted class="w-full h-full object-cover scale-x-flip"></video>
                    <div id="no-camera-msg" class="hidden w-full h-full flex items-center justify-center text-white text-xs bg-gray-900/80 backdrop-blur-sm">
                        <div class="text-center">
                            <i data-lucide="video-off" class="w-6 h-6 mx-auto mb-1"></i>
                            <p>No Camera</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Messages Area -->
        <div class="flex-1 flex flex-col bg-white overflow-hidden relative">
            <div id="messages-container" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-3 font-sans">
                <div class="text-center py-4">
                    <div class="inline-flex items-center gap-2 px-4 py-2 bg-blue-50 rounded-full">
                        <div class="h-2 w-2 bg-blue-500 rounded-full pulse-slow"></div>
                        <span class="text-blue-600 text-sm font-medium italic">You're talking to a random stranger. Say Hi!</span>
                    </div>
                </div>
                <!-- Messages will be injected here -->
            </div>
            
            <div id="status-indicator" class="px-6 py-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-t border-blue-100 hidden">
                <div class="flex items-center justify-center gap-3">
                    <div class="flex gap-1">
                        <div class="h-2 w-2 bg-blue-500 rounded-full pulse-slow" style="animation-delay: 0s"></div>
                        <div class="h-2 w-2 bg-blue-500 rounded-full pulse-slow" style="animation-delay: 0.2s"></div>
                        <div class="h-2 w-2 bg-blue-500 rounded-full pulse-slow" style="animation-delay: 0.4s"></div>
                    </div>
                    <p class="text-blue-600 font-semibold text-sm">Looking for someone you can chat with...</p>
                </div>
            </div>
            <div id="disconnect-indicator" class="px-6 py-4 bg-gradient-to-r from-red-50 to-orange-50 border-t border-red-100 hidden">
                <div class="flex items-center justify-center gap-2">
                    <i data-lucide="alert-circle" class="w-5 h-5 text-red-600"></i>
                    <p class="text-red-600 font-bold text-sm">Stranger has disconnected.</p>
                </div>
            </div>

            <!-- Input Controls -->
            <div class="p-3 sm:p-4 md:p-6 bg-gradient-to-r from-gray-50 to-white border-t-2 border-gray-200 flex flex-col sm:flex-row items-stretch sm:items-center gap-2 sm:gap-3 shrink-0 shadow-lg">
                <button id="btn-stop-next" onclick="app.handleStopNext()" class="h-11 sm:h-12 px-4 sm:px-6 font-bold rounded-xl shadow-md text-xs sm:text-sm uppercase tracking-wide transition-all bg-white border-2 border-gray-300 hover:border-red-400 hover:bg-red-50 hover:text-red-600 text-gray-700 active:translate-y-0.5 flex-shrink-0 justify-center items-center">
                    <span class="flex items-center gap-1.5">
                        <i data-lucide="arrow-right" class="w-4 h-4"></i>
                    </span>
                    <span class="ml-1 text-xs text-gray-400 hidden sm:block -mt-0.5">Esc</span>
                </button>

                <div class="flex-1 relative flex items-center">
                    <input type="text" id="msg-input" placeholder="Waiting..." disabled
                        class="w-full h-11 sm:h-12 pl-4 sm:pl-5 pr-12 sm:pr-14 rounded-xl border-2 border-gray-300 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 disabled:bg-gray-100 disabled:text-gray-400 disabled:cursor-not-allowed text-gray-800 placeholder-gray-400 font-medium shadow-sm transition-all text-sm sm:text-base">
                    <button id="btn-send" onclick="app.sendMessage()" disabled
                        class="absolute right-2 top-1/2 transform -translate-y-1/2 h-7 w-7 sm:h-8 sm:w-8 flex items-center justify-center rounded-lg bg-gradient-primary text-white hover:shadow-lg disabled:opacity-40 disabled:cursor-not-allowed transition-all active:scale-95">
                        <i data-lucide="send" class="w-3.5 h-3.5 sm:w-4 sm:h-4"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import modules
        import { initDOM } from './js/dom.js';
        import { state } from './js/state.js';
        import { startCamera, stopCamera } from './js/camera.js';
        import { host, join, sendMessage as sendP2PMessage, disconnect as disconnectP2P, stopHosting } from './js/hosting.js';
        import { startDiscoveryHost, connectToDiscovery } from './js/discovery.js';
        import { showAlert } from './js/alert.js';
        
        // Make functions available globally
        window.host = host;
        window.join = join;
        window.sendP2PMessage = sendP2PMessage;
        window.disconnectP2P = disconnectP2P;
        window.stopHosting = stopHosting;

        // --- Logic ---
        const app = {
            user: null,
            status: 'idle', // idle, searching, connected, disconnected
            mode: 'text',
            roomId: null,
            searchInterval: null,
            localStream: null,
            lookingForMatch: false,

            // DOM Elements
            el: {
                welcomeScreen: document.getElementById('welcome-screen'),
                chatScreen: document.getElementById('chat-screen'),
                messagesContainer: document.getElementById('messages-container'),
                msgInput: document.getElementById('msg-input'),
                btnSend: document.getElementById('btn-send'),
                btnStopNext: document.getElementById('btn-stop-next'),
                statusInd: document.getElementById('status-indicator'),
                disconnectInd: document.getElementById('disconnect-indicator'),
                videoContainer: document.getElementById('video-container'),
                localVideo: document.getElementById('local-video'),
                noCameraMsg: document.getElementById('no-camera-msg'),
                videoWaitingMsg: document.getElementById('video-waiting-msg'),
                onlineCount: document.getElementById('online-count')
            },

            init: async function() {
                // Initialize DOM references
                initDOM();
                
                // Initialize Lucide Icons
                lucide.createIcons();

                // Generate User ID
                this.user = { uid: 'user_' + Math.random().toString(36).substr(2, 9) };
                state.userId = this.user.uid;
                
                // Update online count
                this.updateOnlineCount();
                
                // Update online count periodically
                setInterval(() => {
                    this.updateOnlineCount();
                }, 5000); // Update every 5 seconds

                // Start discovery host (for session discovery)
                startDiscoveryHost();

                // Check for join parameter in URL
                const urlParams = new URLSearchParams(window.location.search);
                const joinCode = urlParams.get('join');
                if (joinCode) {
                    this.joinSession(joinCode);
                }

                // Input Listeners
                this.el.msgInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });

                // Global Key Listener
                window.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') this.handleStopNext();
                });
            },

            // --- Core Actions ---

            startChat: async function(mode) {
                // Save mode to localStorage
                localStorage.setItem('codmegle_mode', mode);
                
                // Navigate to chat.html with mode parameter
                window.location.href = `chat.html?mode=${mode}`;
            },
            
            startMatching: async function() {
                this.lookingForMatch = true;
                
                // Strategy: Become a host first, then continuously search for available hosts via discovery
                // This way we're ready to accept connections immediately
                
                // Start hosting (this will generate a 5-character code and register with discovery)
                try {
                    await host();
                    
                    // Wait for host peer to be ready before searching
                    await new Promise((resolve) => {
                        if (state.peer && state.peer.open) {
                            resolve();
                        } else if (state.peer) {
                            state.peer.once('open', resolve);
                        } else {
                            setTimeout(resolve, 2000); // Fallback timeout
                        }
                    });
                    
                    // Continuously search for available hosts via discovery and connect
                    let isSearching = false; // Prevent concurrent searches
                    let attemptedPeers = new Set(); // Track attempted peers to avoid immediate retries
                    let currentConnectionAttempt = null; // Track current connection attempt
                    
                    const searchInterval = setInterval(async () => {
                        // Stop searching if already connected or not looking anymore
                        if (!this.lookingForMatch || state.isConnected) {
                            clearInterval(searchInterval);
                            this.searchInterval = null;
                            return;
                        }
                        
                        // Don't search if we're currently attempting a connection (unless it's been too long)
                        if (currentConnectionAttempt) {
                            // If we've been trying for more than 10 seconds, clear it and try next
                            return;
                        }
                        
                        // Prevent concurrent discovery calls
                        if (isSearching) {
                            return;
                        }
                        
                        isSearching = true;
                        try {
                            // Get sessions filtered by current mode (text or video)
                            const currentMode = this.mode || 'video';
                            const sessions = await connectToDiscovery(null, currentMode);
                            
                            // Filter out our own session, attempted peers, and get available Codmegle hosts
                            // Only 5-character codes are valid Codmegle sessions
                            // Also ensure mode matches (text with text, video with video)
                            const availableHosts = sessions.filter(s => {
                                // Strictly avoid self-connection - check against our current share code
                                const isNotSelf = s.code !== state.currentShareCode;
                                const isValidCode = s.code && s.code.length === 5;
                                const notAttempted = !attemptedPeers.has(s.code);
                                // Double-check: make sure code exists and is not empty
                                const hasValidCode = s.code && s.code.trim().length > 0;
                                // Ensure mode matches (text with text, video with video) - strict matching
                                const sessionMode = s.mode || 'video';
                                const modeMatches = sessionMode === currentMode;
                                if (!modeMatches) {
                                    console.log(`Filtering out session ${s.code}: mode mismatch (session: ${sessionMode}, current: ${currentMode})`);
                                }
                                return isNotSelf && isValidCode && notAttempted && hasValidCode && modeMatches;
                            });
                            
                            if (sessions.length > 0 && availableHosts.length < sessions.length) {
                                console.log(`Filtered: ${sessions.length - availableHosts.length} (self/attempted/invalid), ${availableHosts.length} available`);
                            }
                            
                            if (availableHosts.length > 0) {
                                // Randomly select a host from available ones
                                const randomIndex = Math.floor(Math.random() * availableHosts.length);
                                const selectedHost = availableHosts[randomIndex];
                                
                                console.log(`Found ${availableHosts.length} available hosts, attempting: ${selectedHost.code}`);
                                
                                // Mark as attempted
                                attemptedPeers.add(selectedHost.code);
                                
                                // Clear old attempts after a while (30 seconds)
                                if (attemptedPeers.size > 20) {
                                    console.log('Clearing old attempted peers list');
                                    attemptedPeers.clear();
                                }
                                
                                // Set current connection attempt
                                currentConnectionAttempt = selectedHost.code;
                                
                                // Wait a moment for peer readiness
                                await new Promise(resolve => setTimeout(resolve, 1000));
                                
                                // Double-check we're still looking
                                if (!this.lookingForMatch || state.isConnected) {
                                    currentConnectionAttempt = null;
                                    isSearching = false;
                                    return;
                                }
                                
                                // Attempt connection directly - join() will handle it
                                // Set timeout to clear attempt if not connected
                                currentConnectionAttempt = selectedHost.code;
                                
                                // Call join directly - it will set up the connection
                                join(selectedHost.code);
                                
                                // Set timeout to clear attempt flag if connection fails
                                setTimeout(() => {
                                    if (!state.isConnected && currentConnectionAttempt === selectedHost.code) {
                                        console.log(`Connection to ${selectedHost.code} failed/timed out, will try next peer`);
                                        currentConnectionAttempt = null;
                                    }
                                }, 12000); // 12 second timeout
                            } else {
                                // No available hosts - clear old attempts to retry them
                                if (attemptedPeers.size > 10) {
                                    console.log('No new peers, clearing attempted list to retry');
                                    attemptedPeers.clear();
                                }
                                console.log('No available hosts found, waiting...');
                            }
                        } catch (err) {
                            console.warn("Discovery error:", err);
                            // Continue searching
                        } finally {
                            isSearching = false;
                        }
                    }, 2000); // Search every 2 seconds for faster matching
                    
                    // Store interval so we can clear it if needed
                    this.searchInterval = searchInterval;
                    
                } catch (err) {
                    console.error("Failed to start hosting:", err);
                    showAlert("Failed to start connection. Please try again.", 'error');
                    this.status = 'idle';
                    state.isSearching = false;
                    this.updateUIState();
                }
            },
            
            joinSession: function(code) {
                // Navigate to chat.html with join code
                window.location.href = `chat.html?join=${code}`;
            },

            handleStopNext: function() {
                if (this.status === 'connected' || this.status === 'searching') {
                    // Stop current connection
                    this.disconnectChat();
                } else if (this.status === 'disconnected') {
                    // Start New Chat - fully reset and start fresh
                    this.disconnectChat(); // Ensure clean
                    
                    // Small delay to ensure cleanup completes
                    setTimeout(() => {
                        this.startChat(this.mode);
                    }, 500);
                }
            },

            disconnectChat: function() {
                // Send disconnect message and close P2P connection
                disconnectP2P();
                stopHosting();
                
                // Stop camera if in video mode
                if (this.mode === 'video') {
                    this.stopCamera();
                }
                
                this.stopBroadcastingSearch();
                this.status = 'disconnected';
                this.lookingForMatch = false;
                state.isConnected = false;
                state.isSearching = false;
                
                // Clear messages
                this.el.messagesContainer.innerHTML = '<div class="text-center py-4"><div class="inline-flex items-center gap-2 px-4 py-2 bg-red-50 rounded-full"><i data-lucide="alert-circle" class="w-4 h-4 text-red-600"></i><span class="text-red-600 text-sm font-medium">Stranger has disconnected.</span></div></div>';
                if (window.lucide) {
                    lucide.createIcons();
                }
                
                this.updateUIState();
            },

            sendMessage: function() {
                const text = this.el.msgInput.value.trim();
                if (!text || this.status !== 'connected' || !state.isConnected) return;

                const msgPayload = {
                    type: 'CHAT',
                    sender: this.user.uid,
                    text: text,
                    timestamp: Date.now()
                };

                // Add to local UI
                this.appendMessage(msgPayload);

                // Send via P2P data connection
                if (!sendP2PMessage(text, this.user.uid)) {
                    showAlert("Message could not be sent. Connection may be lost.", 'warning');
                }

                this.el.msgInput.value = '';
            },

            // --- Matchmaking Logic ---

            stopBroadcastingSearch: function() {
                if (this.searchInterval) {
                    clearInterval(this.searchInterval);
                    this.searchInterval = null;
                }
                this.lookingForMatch = false;
            },

            // --- Media Helper ---
            
            startCamera: async function() {
                try {
                    const stream = await startCamera();
                    this.localStream = stream;
                    if (this.el.localVideo) {
                        this.el.localVideo.srcObject = stream;
                        this.el.localVideo.classList.remove('hidden');
                        // Ensure video plays
                        try {
                            await this.el.localVideo.play();
                        } catch (playErr) {
                            console.warn("Video play error:", playErr);
                        }
                    }
                    if (this.el.noCameraMsg) {
                        this.el.noCameraMsg.classList.add('hidden');
                    }
                } catch (e) {
                    console.error("Camera error", e);
                    if (this.el.localVideo) {
                        this.el.localVideo.classList.add('hidden');
                    }
                    if (this.el.noCameraMsg) {
                        this.el.noCameraMsg.classList.remove('hidden');
                    }
                    throw e;
                }
            },

            stopCamera: function() {
                stopCamera();
                this.localStream = null;
                if (this.el.localVideo) {
                    this.el.localVideo.srcObject = null;
                }
            },

            // --- UI Helpers ---

            updateUIState: function() {
                const isConnected = this.status === 'connected';
                const isSearching = this.status === 'searching';
                const isDisconnected = this.status === 'disconnected';

                // Controls
                this.el.msgInput.disabled = !isConnected;
                this.el.btnSend.disabled = !isConnected;
                this.el.msgInput.placeholder = isConnected ? "Type your message..." : (isDisconnected ? "Stranger disconnected" : "Waiting for connection...");
                
                // Button Text
                if (isDisconnected) {
                    this.el.btnStopNext.className = "h-12 px-6 font-bold rounded-xl shadow-md text-sm uppercase tracking-wide transition-all bg-gradient-primary hover:shadow-lg text-white active:translate-y-0.5 flex-shrink-0";
                    this.el.btnStopNext.innerHTML = '<span class="flex items-center gap-1.5"><i data-lucide="refresh-cw" class="w-4 h-4"></i><span>New Chat</span></span><span class="ml-1 text-xs text-blue-200 block -mt-0.5">Esc</span>';
                } else {
                    this.el.btnStopNext.className = "h-12 px-6 font-bold rounded-xl shadow-md text-sm uppercase tracking-wide transition-all bg-white border-2 border-gray-300 hover:border-red-400 hover:bg-red-50 hover:text-red-600 text-gray-700 active:translate-y-0.5 flex-shrink-0";
                    this.el.btnStopNext.innerHTML = '<span class="flex items-center gap-1.5"><i data-lucide="arrow-right" class="w-4 h-4"></i></span><span class="ml-1 text-xs text-gray-400 block -mt-0.5">Esc</span>';
                }
                
                // Re-initialize icons after button update
                if (window.lucide) {
                    lucide.createIcons();
                }

                // Indicators
                this.el.statusInd.classList.toggle('hidden', !isSearching);
                this.el.disconnectInd.classList.toggle('hidden', !isDisconnected);
                this.el.videoWaitingMsg.classList.toggle('hidden', !isSearching);

                // Auto Focus
                if (isConnected) this.el.msgInput.focus();
            },

            appendMessage: function(msg) {
                const isMe = msg.sender === this.user.uid;
                const div = document.createElement('div');
                div.className = `message-bubble flex ${isMe ? 'justify-end' : 'justify-start'} mb-3`;
                
                const time = new Date(msg.timestamp);
                const timeStr = time.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                
                div.innerHTML = `
                    <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'} max-w-[75%] md:max-w-[60%]">
                        <div class="flex items-center gap-2 mb-1 px-1">
                            <span class="text-xs font-semibold ${isMe ? 'text-blue-600' : 'text-gray-600'}">${isMe ? 'You' : 'Stranger'}</span>
                            <span class="text-xs text-gray-400">${timeStr}</span>
                        </div>
                        <div class="px-4 py-2.5 rounded-2xl shadow-md ${isMe ? 'bg-gradient-message-you text-white rounded-br-sm' : 'bg-gradient-message-stranger text-gray-800 border border-gray-200 rounded-bl-sm'}">
                            <p class="break-words text-sm leading-relaxed">${this.escapeHtml(msg.text)}</p>
                        </div>
                    </div>
                `;
                this.el.messagesContainer.appendChild(div);
                this.el.messagesContainer.scrollTop = this.el.messagesContainer.scrollHeight;
                
                // Re-initialize icons for new message
                if (window.lucide) {
                    lucide.createIcons();
                }
            },

            escapeHtml: function(unsafe) {
                return unsafe
                     .replace(/&/g, "&amp;")
                     .replace(/</g, "&lt;")
                     .replace(/>/g, "&gt;")
                     .replace(/"/g, "&quot;")
                     .replace(/'/g, "&#039;");
            },
            
            updateOnlineCount: async function() {
                try {
                    // Get all sessions (no mode filter for count)
                    const allSessions = await connectToDiscovery();
                    // Count only valid Codmegle sessions (5-character codes)
                    const validSessions = allSessions.filter(s => s.code && s.code.length === 5);
                    const count = validSessions.length;
                    this.el.onlineCount.innerText = count > 0 ? count.toLocaleString() + ' online' : 'Connecting...';
                } catch (err) {
                    console.warn("Error updating online count:", err);
                    this.el.onlineCount.innerText = '... online now';
                }
            }
        };

        // Make app available globally
        window.app = app;
        
        // Run
        window.onload = function() {
            app.init();
        };

    </script>
</body>
</html>